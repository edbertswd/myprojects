{% extends "admin/change_form.html" %}

{% block extrahead %}
{{ block.super }}
<style>
    .addressr-suggestions {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .addressr-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .addressr-suggestion:hover {
        background: #f0f0f0;
    }
</style>
<script>
(function() {
    let debounceTimer;
    let suggestionsDiv;

    function initAddressAutocomplete() {
        const addressField = document.querySelector('input[name="address"]');
        const latField = document.querySelector('input[name="latitude"]');
        const lonField = document.querySelector('input[name="longitude"]');

        if (!addressField) return;

        // Create suggestions container
        suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'addressr-suggestions';
        suggestionsDiv.style.display = 'none';
        addressField.parentNode.style.position = 'relative';
        addressField.parentNode.appendChild(suggestionsDiv);

        // Add input listener
        addressField.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            const query = e.target.value.trim();

            if (query.length < 3) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(() => {
                searchAddress(query);
            }, 300);
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!addressField.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }

    async function searchAddress(query) {
        try {
            // Using Addressr free API
            const response = await fetch(`https://api.addressr.io/addresses/autocomplete?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data && data.addresses && data.addresses.length > 0) {
                displaySuggestions(data.addresses);
            } else {
                suggestionsDiv.style.display = 'none';
            }
        } catch (error) {
            console.error('Address search failed:', error);
            suggestionsDiv.style.display = 'none';
        }
    }

    function displaySuggestions(addresses) {
        suggestionsDiv.innerHTML = '';
        suggestionsDiv.style.display = 'block';

        addresses.forEach(addr => {
            const div = document.createElement('div');
            div.className = 'addressr-suggestion';
            div.textContent = addr.singleLine || addr.address;
            div.addEventListener('click', () => selectAddress(addr));
            suggestionsDiv.appendChild(div);
        });
    }

    async function selectAddress(address) {
        const addressField = document.querySelector('input[name="address"]');
        const latField = document.querySelector('input[name="latitude"]');
        const lonField = document.querySelector('input[name="longitude"]');

        // Set the address
        addressField.value = address.singleLine || address.address;
        suggestionsDiv.style.display = 'none';

        // Get full details including coordinates
        try {
            const response = await fetch(`https://api.addressr.io/addresses/${address.id}`);
            const details = await response.json();

            if (details.latitude && details.longitude) {
                // Remove readonly attribute temporarily
                latField.removeAttribute('readonly');
                lonField.removeAttribute('readonly');

                latField.value = details.latitude;
                lonField.value = details.longitude;

                // Re-add readonly
                latField.setAttribute('readonly', 'readonly');
                lonField.setAttribute('readonly', 'readonly');
            }
        } catch (error) {
            console.error('Failed to fetch address details:', error);
        }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAddressAutocomplete);
    } else {
        initAddressAutocomplete();
    }
})();
</script>
{% endblock %}
